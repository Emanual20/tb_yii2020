(function($){"use strict";var defaults={prefilled:null,CapitalizeFirstLetter:false,preventSubmitOnEnter:true,isClearInputOnEsc:true,externalTagId:false,prefillIdFieldName:'Id',prefillValueFieldName:'Value',AjaxPush:null,AjaxPushAllTags:null,AjaxPushParameters:null,delimiters:[9,13,44],backspace:[8],maxTags:0,hiddenTagListName:null,hiddenTagListId:null,replace:true,output:null,deleteTagsOnBackspace:true,tagsContainer:null,tagCloseIcon:'x',tagClass:'',validator:null,onlyTagList:false,tagList:null,fillInputOnTagRemove:false,},publicMethods={pushTag:function(tag,ignoreEvents,externalTagId){var $self=$(this),opts=$self.data('opts'),alreadyInList,tlisLowerCase,max,tagId,tlis=$self.data("tlis"),tlid=$self.data("tlid"),idx,newTagId,newTagRemoveId,escaped,html,$el,lastTagId,lastTagObj;tag=privateMethods.trimTag(tag,opts.delimiterChars);if(!tag||tag.length<=0){return;}
if(opts.onlyTagList&&undefined!==opts.tagList){if(opts.tagList){var $tagList=opts.tagList;$.each($tagList,function(index,item){$tagList[index]=item.toLowerCase();});var suggestion=$.inArray(tag.toLowerCase(),$tagList);if(-1===suggestion){return;}}}
if(opts.CapitalizeFirstLetter&&tag.length>1){tag=tag.charAt(0).toUpperCase()+ tag.slice(1).toLowerCase();}
if(opts.validator&&!opts.validator(tag)){return;}
if(opts.maxTags>0&&tlis.length>=opts.maxTags){return;}
alreadyInList=false;tlisLowerCase=jQuery.map(tlis,function(elem){return elem.toLowerCase();});idx=$.inArray(tag.toLowerCase(),tlisLowerCase);if(-1!==idx){alreadyInList=true;}
if(alreadyInList){$self.trigger('tm:duplicated',tag);$("#"+ $self.data("tm_rndid")+"_"+ tlid[idx]).stop().animate({backgroundColor:opts.blinkBGColor_1},100).animate({backgroundColor:opts.blinkBGColor_2},100).animate({backgroundColor:opts.blinkBGColor_1},100).animate({backgroundColor:opts.blinkBGColor_2},100).animate({backgroundColor:opts.blinkBGColor_1},100).animate({backgroundColor:opts.blinkBGColor_2},100);}else{if(opts.externalTagId===true){if(externalTagId===undefined){$.error('externalTagId is not passed for tag -'+ tag);}
tagId=externalTagId;}else{max=Math.max.apply(null,tlid);max=max===-Infinity?0:max;tagId=++max;}
if(!ignoreEvents){$self.trigger('tm:pushing',[tag,tagId]);}
tlis.push(tag);tlid.push(tagId);if(!ignoreEvents)
if(opts.AjaxPush!==null&&opts.AjaxPushAllTags==null){if($.inArray(tag,opts.prefilled)===-1){$.post(opts.AjaxPush,$.extend({tag:tag},opts.AjaxPushParameters));}}
newTagId=$self.data("tm_rndid")+'_'+ tagId;newTagRemoveId=$self.data("tm_rndid")+'_Remover_'+ tagId;escaped=$("<span/>").text(tag).html();html='<span class="'+ privateMethods.tagClasses.call($self)+'" id="'+ newTagId+'">';html+='<span>'+ escaped+'</span>';html+='<a href="#" class="tm-tag-remove" id="'+ newTagRemoveId+'" TagIdToRemove="'+ tagId+'">';html+=opts.tagCloseIcon+'</a></span> ';$el=$(html);if(opts.tagsContainer!==null){$(opts.tagsContainer).append($el);}else{if(tlid.length>1){lastTagObj=$("#"+ $self.data("tm_rndid")+"_"+ tlid[tlid.length- 2]);lastTagObj.after($el);}else{$self.before($el);}}
$el.find("#"+ newTagRemoveId).on("click",$self,function(e){e.preventDefault();var TagIdToRemove=parseInt($(this).attr("TagIdToRemove"));privateMethods.spliceTag.call($self,TagIdToRemove,e.data);});privateMethods.refreshHiddenTagList.call($self);if(!ignoreEvents){$self.trigger('tm:pushed',[tag,tagId]);}
privateMethods.showOrHide.call($self);}
$self.val("");},popTag:function(){var $self=$(this),tagId,tagBeingRemoved,tlis=$self.data("tlis"),tlid=$self.data("tlid");if(tlid.length>0){tagId=tlid.pop();tagBeingRemoved=tlis[tlis.length- 1];$self.trigger('tm:popping',[tagBeingRemoved,tagId]);tlis.pop();$("#"+ $self.data("tm_rndid")+"_"+ tagId).remove();privateMethods.refreshHiddenTagList.call($self);$self.trigger('tm:popped',[tagBeingRemoved,tagId]);}},empty:function(){var $self=$(this),tlis=$self.data("tlis"),tlid=$self.data("tlid"),tagId;while(tlid.length>0){tagId=tlid.pop();tlis.pop();$("#"+ $self.data("tm_rndid")+"_"+ tagId).remove();privateMethods.refreshHiddenTagList.call($self);}
$self.trigger('tm:emptied',null);privateMethods.showOrHide.call($self);},tags:function(){var $self=this,tlis=$self.data("tlis");return tlis;}},privateMethods={showOrHide:function(){var $self=this,opts=$self.data('opts'),tlis=$self.data("tlis");if(opts.maxTags>0&&tlis.length<opts.maxTags){$self.show();$self.trigger('tm:show');}
if(opts.maxTags>0&&tlis.length>=opts.maxTags){$self.hide();$self.trigger('tm:hide');}},tagClasses:function(){var $self=$(this),opts=$self.data('opts'),tagBaseClass=opts.tagBaseClass,inputBaseClass=opts.inputBaseClass,cl;cl=tagBaseClass;if($self.attr('class')){$.each($self.attr('class').split(' '),function(index,value){if(value.indexOf(inputBaseClass+'-')!==-1){cl+=' '+ tagBaseClass+ value.substring(inputBaseClass.length);}});}
cl+=(opts.tagClass?' '+ opts.tagClass:'');return cl;},trimTag:function(tag,delimiterChars){var i;tag=$.trim(tag);i=0;for(i;i<tag.length;i++){if($.inArray(tag.charCodeAt(i),delimiterChars)!==-1){break;}}
return tag.substring(0,i);},refreshHiddenTagList:function(){var $self=$(this),tlis=$self.data("tlis"),lhiddenTagList=$self.data("lhiddenTagList");if(lhiddenTagList){$(lhiddenTagList).val(tlis.join($self.data('opts').baseDelimiter)).change();}
$self.trigger('tm:refresh',tlis.join($self.data('opts').baseDelimiter));},killEvent:function(e){e.cancelBubble=true;e.returnValue=false;e.stopPropagation();e.preventDefault();},keyInArray:function(e,ary){return $.inArray(e.which,ary)!==-1;},applyDelimiter:function(e){var $self=$(this);publicMethods.pushTag.call($self,$(this).val());e.preventDefault();},prefill:function(pta){var $self=$(this);var opts=$self.data('opts')
$.each(pta,function(key,val){if(opts.externalTagId===true){publicMethods.pushTag.call($self,val[opts.prefillValueFieldName],true,val[opts.prefillIdFieldName]);}else{publicMethods.pushTag.call($self,val,true);}});},pushAllTags:function(e,tag){var $self=$(this),opts=$self.data('opts'),tlis=$self.data("tlis");if(opts.AjaxPushAllTags){if(e.type!=='tm:pushed'||$.inArray(tag,opts.prefilled)===-1){$.post(opts.AjaxPush,$.extend({tags:tlis.join(opts.baseDelimiter)},opts.AjaxPushParameters));}}},spliceTag:function(tagId){var $self=this,tlis=$self.data("tlis"),tlid=$self.data("tlid"),idx=$.inArray(tagId,tlid),tagBeingRemoved;if(-1!==idx){tagBeingRemoved=tlis[idx];$self.trigger('tm:splicing',[tagBeingRemoved,tagId]);$("#"+ $self.data("tm_rndid")+"_"+ tagId).remove();tlis.splice(idx,1);tlid.splice(idx,1);privateMethods.refreshHiddenTagList.call($self);$self.trigger('tm:spliced',[tagBeingRemoved,tagId]);}
privateMethods.showOrHide.call($self);},init:function(options){var opts=$.extend({},defaults,options),delimiters,keyNums;opts.hiddenTagListName=(opts.hiddenTagListName===null)?'hidden-'+ this.attr('name'):opts.hiddenTagListName;delimiters=opts.delimeters||opts.delimiters;keyNums=[9,13,17,18,19,37,38,39,40];opts.delimiterChars=[];opts.delimiterKeys=[];$.each(delimiters,function(i,v){if($.inArray(v,keyNums)!==-1){opts.delimiterKeys.push(v);}else{opts.delimiterChars.push(v);}});opts.baseDelimiter=String.fromCharCode(opts.delimiterChars[0]||44);opts.tagBaseClass='tm-tag';opts.inputBaseClass='tm-input';if(!$.isFunction(opts.validator)){opts.validator=null;}
this.each(function(){var $self=$(this),hiddenObj='',rndid='',albet="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";if($self.data('tagManager')){return false;}
$self.data('tagManager',true);for(var i=0;i<5;i++){rndid+=albet.charAt(Math.floor(Math.random()*albet.length));}
$self.data("tm_rndid",rndid);$self.data('opts',opts).data('tlis',[]).data('tlid',[]);if(opts.output===null){hiddenObj=$('<input/>',{type:'hidden',name:opts.hiddenTagListName});$self.after(hiddenObj);$self.data("lhiddenTagList",hiddenObj);}else{$self.data("lhiddenTagList",$(opts.output));}
if(opts.AjaxPushAllTags){$self.on('tm:spliced',privateMethods.pushAllTags);$self.on('tm:popped',privateMethods.pushAllTags);$self.on('tm:pushed',privateMethods.pushAllTags);}
$self.on('focus keypress',function(e){if($(this).popover){$(this).popover('hide');}});if(opts.isClearInputOnEsc){$self.on('keyup',function(e){if(e.which===27){$(this).val('');privateMethods.killEvent(e);}});}
$self.on('keypress',function(e){if(privateMethods.keyInArray(e,opts.delimiterChars)){privateMethods.applyDelimiter.call($self,e);}});$self.on('keydown',function(e){if(e.which===13){if(opts.preventSubmitOnEnter){privateMethods.killEvent(e);}}
if(privateMethods.keyInArray(e,opts.delimiterKeys)){privateMethods.applyDelimiter.call($self,e);}});if(opts.deleteTagsOnBackspace){$self.on('keydown',function(e){if(privateMethods.keyInArray(e,opts.backspace)){if($(this).val().length<=0){publicMethods.popTag.call($self);privateMethods.killEvent(e);}}});}
if(opts.fillInputOnTagRemove){$self.on('tm:popped',function(e,tag){$(this).val(tag);});}
$self.change(function(e){if(!/webkit/.test(navigator.userAgent.toLowerCase())){$self.focus();}
privateMethods.killEvent(e);});if(opts.prefilled!==null){if(typeof(opts.prefilled)==="object"){privateMethods.prefill.call($self,opts.prefilled);}else if(typeof(opts.prefilled)==="string"){privateMethods.prefill.call($self,opts.prefilled.split(opts.baseDelimiter));}else if(typeof(opts.prefilled)==="function"){privateMethods.prefill.call($self,opts.prefilled());}}else if(opts.output!==null){if($(opts.output)&&$(opts.output).val()){var existing_tags=$(opts.output);}
privateMethods.prefill.call($self,$(opts.output).val().split(opts.baseDelimiter));}});return this;}};$.fn.tagsManager=function(method){var $self=$(this);if(!(0 in this)){return this;}
if(publicMethods[method]){return publicMethods[method].apply($self,Array.prototype.slice.call(arguments,1));}else if(typeof method==='object'||!method){return privateMethods.init.apply(this,arguments);}else{$.error('Method '+ method+' does not exist.');return false;}};}(jQuery));